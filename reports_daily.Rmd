cat("Render time: ", as.character(Sys.time()))
knitr::opts_chunk$set(cache = FALSE)

---
title: "Florida Pick 2 — Daily Report"
output: html_document
---

```{r setup, include=FALSE}
suppressPackageStartupMessages({
  library(readr); library(dplyr); library(ggplot2)
})
pick2 <- readr::read_csv("data/clean/pick2_history.csv", show_col_types = FALSE)
```

## Latest rows
```{r}
head(pick2, 10)
```

## d1 distribution
```{r}
pick2 |>
  count(d1) |>
  ggplot(aes(factor(d1), n)) +
  geom_col() +
  labs(x = "d1", y = "count")
```

## Top-25 (raw)
```{r}
if (file.exists("outputs/top25_pairs_next_draw.csv")) {
  readr::read_csv("outputs/top25_pairs_next_draw.csv", show_col_types = FALSE) |> head(10)
} else {
  cat("No raw top-25 file yet.")
}
```

## Calibrated Top-25
```{r}
if (file.exists("outputs/top25_pairs_next_draw_cal.csv")) {
  readr::read_csv("outputs/top25_pairs_next_draw_cal.csv", show_col_types = FALSE) |> head(10)
} else {
  cat("No calibrated file yet.")
}
```

## Backoff Blend & Calibration (New)

```{r backoff-blend-load, message=FALSE, warning=FALSE}
library(readr); library(dplyr); library(tidyr); library(knitr)

# Helper to read and show top-k
show_topk <- function(path, k = 10, title = basename(path)) {
  if (!file.exists(path)) return(invisible(NULL))
  df <- readr::read_csv(path, show_col_types = FALSE)
  names(df) <- tolower(names(df))
  # Expect columns: time, d1, d2, prob
  if (!all(c("d1","d2","prob") %in% names(df))) return(invisible(NULL))
  df %>%
    arrange(desc(prob)) %>%
    head(k) %>%
    mutate(pair = paste0(d1, d2)) %>%
    select(pair, prob) %>%
    knitr::kable(caption = paste0("Top ", k, " — ", title), digits = 5)
}

show_topk("outputs/predictions_backoff_blend_M.csv", 10, "Backoff Blend (Morning)")
show_topk("outputs/predictions_backoff_blend_E.csv", 10, "Backoff Blend (Evening)")
show_topk("outputs/predictions_backoff_blend_M_cal.csv", 10, "Backoff Blend Calibrated (Morning)")
show_topk("outputs/predictions_backoff_blend_E_cal.csv", 10, "Backoff Blend Calibrated (Evening)")

if (file.exists("outputs/reliability_plot.png")) {
  knitr::include_graphics("outputs/reliability_plot.png")
}

if (file.exists("outputs/mi_lift_heatmap.png")) {
  knitr::include_graphics("outputs/mi_lift_heatmap.png")
}

if (file.exists("outputs/uplift_summary.txt")) {
  cat(readLines("outputs/uplift_summary.txt"), sep = "\n")
}

## Weekday Blend Tops

```{r weekday-blend-tops, message=FALSE, warning=FALSE}
library(readr); library(dplyr); library(knitr)

# Helper to render top-k rows (define if missing)
if (!exists("show_topk")) {
  show_topk <- function(path, k = 10, title = basename(path)) {
    if (!file.exists(path)) return(invisible(NULL))
    df <- readr::read_csv(path, show_col_types = FALSE)
    names(df) <- tolower(names(df))
    if (!all(c("d1","d2","prob") %in% names(df))) return(invisible(NULL))
    df %>%
      dplyr::arrange(dplyr::desc(prob)) %>%
      dplyr::slice_head(n = k) %>%
      dplyr::mutate(pair = paste0(d1, d2)) %>%
      dplyr::select(pair, prob) %>%
      knitr::kable(caption = paste0("Top ", k, " — ", title), digits = 5)
  }
}

show_topk("outputs/predictions_weekday_blend_M.csv", 10, "Weekday Blend (Morning)")
show_topk("outputs/predictions_weekday_blend_E.csv", 10, "Weekday Blend (Evening)")
```

## Methods (Quick)

- Base: frequency of pairs over all history.
- Weekday×Time blend: p_BW = (1 - alpha_W) * p_base + alpha_W * p_weekday.
- Markov backoff: Laplace-smoothed P(next|last) blended: p = (1 - alpha_M) * p_BW + alpha_M * p_markov.
- Calibration: Platt scaling (logistic) on backtests; renormalized per draw.
- Uplift: Paired bootstrap CI on log-loss vs. uniform.

Weights loaded from `data/analysis/weights_backoff.yml`.

## How much pattern signal?

```{r pattern-quant, message=FALSE, warning=FALSE}
library(readr); library(dplyr); library(knitr)
if (file.exists("data/analysis/patterns_quant_summary.csv")) {
  readr::read_csv("data/analysis/patterns_quant_summary.csv", show_col_types = FALSE) |>
    mutate(across(c(logloss, brier, gain_vs_uniform), round, 5)) |>
    knitr::kable(caption = "Walk-forward metrics (lower is better). gain_vs_uniform = (LL_uniform - LL_model)/LL_uniform")
}
if (file.exists("outputs/topk_curves.png")) {
  knitr::include_graphics("outputs/topk_curves.png")
}

## Extra Pattern Summaries

```{r extra-patterns, message=FALSE, warning=FALSE}
library(readr); library(dplyr); library(knitr)
if (file.exists("data/analysis/gap_distribution.csv"))
  readr::read_csv("data/analysis/gap_distribution.csv", show_col_types=FALSE) |>
    slice_head(n=25) |>
    knitr::kable(caption="Gap distribution (first 25 gaps)")
if (file.exists("data/analysis/pair_zscan.csv"))
  readr::read_csv("data/analysis/pair_zscan.csv", show_col_types=FALSE) |>
    slice_head(n=20) |>
    knitr::kable(caption="Top 20 pairs by z-score vs uniform")
if (file.exists("outputs/gap_distribution.png")) knitr::include_graphics("outputs/gap_distribution.png")
if (file.exists("outputs/pair_zscan_top20.png")) knitr::include_graphics("outputs/pair_zscan_top20.png")
```
