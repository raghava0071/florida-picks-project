cat("Render time: ", as.character(Sys.time()))
knitr::opts_chunk$set(cache = FALSE)

---
title: "Florida Pick 2 — Daily Report"
output: html_document
---

```{r setup, include=FALSE}
suppressPackageStartupMessages({
  library(readr); library(dplyr); library(ggplot2)
})
pick2 <- readr::read_csv("data/clean/pick2_history.csv", show_col_types = FALSE)
```

## Latest rows
```{r}
head(pick2, 10)
```

## d1 distribution
```{r}
pick2 |>
  count(d1) |>
  ggplot(aes(factor(d1), n)) +
  geom_col() +
  labs(x = "d1", y = "count")
```

## Top-25 (raw)
```{r}
if (file.exists("outputs/top25_pairs_next_draw.csv")) {
  readr::read_csv("outputs/top25_pairs_next_draw.csv", show_col_types = FALSE) |> head(10)
} else {
  cat("No raw top-25 file yet.")
}
```

## Calibrated Top-25
```{r}
if (file.exists("outputs/top25_pairs_next_draw_cal.csv")) {
  readr::read_csv("outputs/top25_pairs_next_draw_cal.csv", show_col_types = FALSE) |> head(10)
} else {
  cat("No calibrated file yet.")
}
```

## Backoff Blend & Calibration (New)

```{r backoff-blend-load, message=FALSE, warning=FALSE}
library(readr); library(dplyr); library(tidyr); library(knitr)

# Helper to read and show top-k
show_topk <- function(path, k = 10, title = basename(path)) {
  if (!file.exists(path)) return(invisible(NULL))
  df <- readr::read_csv(path, show_col_types = FALSE)
  names(df) <- tolower(names(df))
  # Expect columns: time, d1, d2, prob
  if (!all(c("d1","d2","prob") %in% names(df))) return(invisible(NULL))
  df %>%
    arrange(desc(prob)) %>%
    head(k) %>%
    mutate(pair = paste0(d1, d2)) %>%
    select(pair, prob) %>%
    knitr::kable(caption = paste0("Top ", k, " — ", title), digits = 5)
}

show_topk("outputs/predictions_backoff_blend_M.csv", 10, "Backoff Blend (Morning)")
show_topk("outputs/predictions_backoff_blend_E.csv", 10, "Backoff Blend (Evening)")
show_topk("outputs/predictions_backoff_blend_M_cal.csv", 10, "Backoff Blend Calibrated (Morning)")
show_topk("outputs/predictions_backoff_blend_E_cal.csv", 10, "Backoff Blend Calibrated (Evening)")

if (file.exists("outputs/reliability_plot.png")) {
  knitr::include_graphics("outputs/reliability_plot.png")
}

if (file.exists("outputs/mi_lift_heatmap.png")) {
  knitr::include_graphics("outputs/mi_lift_heatmap.png")
}

if (file.exists("outputs/uplift_summary.txt")) {
  cat(readLines("outputs/uplift_summary.txt"), sep = "\n")
}


If you also want to show **weekday-blend** tops:

```markdown
```{r weekday-blend-tops, message=FALSE, warning=FALSE}
show_topk("outputs/predictions_weekday_blend_M.csv", 10, "Weekday Blend (Morning)")
show_topk("outputs/predictions_weekday_blend_E.csv", 10, "Weekday Blend (Evening)")

library(readr); library(dplyr); library(knitr)

# If show_topk isn't already defined earlier in the Rmd, include this helper:
if (!exists("show_topk")) {
  show_topk <- function(path, k = 10, title = basename(path)) {
    if (!file.exists(path)) return(invisible(NULL))
    df <- readr::read_csv(path, show_col_types = FALSE)
    names(df) <- tolower(names(df))
    if (!all(c("d1","d2","prob") %in% names(df))) return(invisible(NULL))
    df |>
      dplyr::arrange(dplyr::desc(prob)) |>
      dplyr::slice_head(n = k) |>
      dplyr::mutate(pair = paste0(d1, d2)) |>
      dplyr::select(pair, prob) |>
      knitr::kable(caption = paste0("Top ", k, " — ", title), digits = 5)
  }
}

show_topk("outputs/predictions_weekday_blend_M.csv", 10, "Weekday Blend (Morning)")
show_topk("outputs/predictions_weekday_blend_E.csv", 10, "Weekday Blend (Evening)")

