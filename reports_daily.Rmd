cat("Render time: ", as.character(Sys.time()))
knitr::opts_chunk$set(cache = FALSE)

---
title: "Florida Pick 2 — Daily Report"
output: html_document
---

```{r setup, include=FALSE}
suppressPackageStartupMessages({
  library(readr); library(dplyr); library(ggplot2)
})
pick2 <- readr::read_csv("data/clean/pick2_history.csv", show_col_types = FALSE)
```

## Latest rows
```{r}
head(pick2, 10)
```

## d1 distribution
```{r}
pick2 |>
  count(d1) |>
  ggplot(aes(factor(d1), n)) +
  geom_col() +
  labs(x = "d1", y = "count")
```

## Top-25 (raw)
```{r}
if (file.exists("outputs/top25_pairs_next_draw.csv")) {
  readr::read_csv("outputs/top25_pairs_next_draw.csv", show_col_types = FALSE) |> head(10)
} else {
  cat("No raw top-25 file yet.")
}
```

## Calibrated Top-25
```{r}
if (file.exists("outputs/top25_pairs_next_draw_cal.csv")) {
  readr::read_csv("outputs/top25_pairs_next_draw_cal.csv", show_col_types = FALSE) |> head(10)
} else {
  cat("No calibrated file yet.")
}
```

## Backoff Blend & Calibration (New)

```{r backoff-blend-load, message=FALSE, warning=FALSE}
library(readr); library(dplyr); library(tidyr); library(knitr)

# Helper to read and show top-k
show_topk <- function(path, k = 10, title = basename(path)) {
  if (!file.exists(path)) return(invisible(NULL))
  df <- readr::read_csv(path, show_col_types = FALSE)
  names(df) <- tolower(names(df))
  # Expect columns: time, d1, d2, prob
  if (!all(c("d1","d2","prob") %in% names(df))) return(invisible(NULL))
  df %>%
    arrange(desc(prob)) %>%
    head(k) %>%
    mutate(pair = paste0(d1, d2)) %>%
    select(pair, prob) %>%
    knitr::kable(caption = paste0("Top ", k, " — ", title), digits = 5)
}

show_topk("outputs/predictions_backoff_blend_M.csv", 10, "Backoff Blend (Morning)")
show_topk("outputs/predictions_backoff_blend_E.csv", 10, "Backoff Blend (Evening)")
show_topk("outputs/predictions_backoff_blend_M_cal.csv", 10, "Backoff Blend Calibrated (Morning)")
show_topk("outputs/predictions_backoff_blend_E_cal.csv", 10, "Backoff Blend Calibrated (Evening)")

if (file.exists("outputs/reliability_plot.png")) {
  knitr::include_graphics("outputs/reliability_plot.png")
}

if (file.exists("outputs/mi_lift_heatmap.png")) {
  knitr::include_graphics("outputs/mi_lift_heatmap.png")
}

if (file.exists("outputs/uplift_summary.txt")) {
  cat(readLines("outputs/uplift_summary.txt"), sep = "\n")
}

## Weekday Blend Tops

```{r weekday-blend-tops, message=FALSE, warning=FALSE}
library(readr); library(dplyr); library(knitr)

# Helper to render top-k rows (define if missing)
if (!exists("show_topk")) {
  show_topk <- function(path, k = 10, title = basename(path)) {
    if (!file.exists(path)) return(invisible(NULL))
    df <- readr::read_csv(path, show_col_types = FALSE)
    names(df) <- tolower(names(df))
    if (!all(c("d1","d2","prob") %in% names(df))) return(invisible(NULL))
    df %>%
      dplyr::arrange(dplyr::desc(prob)) %>%
      dplyr::slice_head(n = k) %>%
      dplyr::mutate(pair = paste0(d1, d2)) %>%
      dplyr::select(pair, prob) %>%
      knitr::kable(caption = paste0("Top ", k, " — ", title), digits = 5)
  }
}

show_topk("outputs/predictions_weekday_blend_M.csv", 10, "Weekday Blend (Morning)")
show_topk("outputs/predictions_weekday_blend_E.csv", 10, "Weekday Blend (Evening)")
```

## Methods (Quick)

- Base: frequency of pairs over all history.
- Weekday×Time blend: p_BW = (1 - alpha_W) * p_base + alpha_W * p_weekday.
- Markov backoff: Laplace-smoothed P(next|last) blended: p = (1 - alpha_M) * p_BW + alpha_M * p_markov.
- Calibration: Platt scaling (logistic) on backtests; renormalized per draw.
- Uplift: Paired bootstrap CI on log-loss vs. uniform.

Weights loaded from `data/analysis/weights_backoff.yml`.

## How much pattern signal?

```{r pattern-quant, message=FALSE, warning=FALSE}
library(readr); library(dplyr); library(knitr)
if (file.exists("data/analysis/patterns_quant_summary.csv")) {
  readr::read_csv("data/analysis/patterns_quant_summary.csv", show_col_types = FALSE) |>
    mutate(across(c(logloss, brier, gain_vs_uniform), round, 5)) |>
    knitr::kable(caption = "Walk-forward metrics (lower is better). gain_vs_uniform = (LL_uniform - LL_model)/LL_uniform")
}
if (file.exists("outputs/topk_curves.png")) {
  knitr::include_graphics("outputs/topk_curves.png")
}

## Extra Pattern Summaries

```{r extra-patterns, message=FALSE, warning=FALSE}
library(readr); library(dplyr); library(knitr)
if (file.exists("data/analysis/gap_distribution.csv"))
  readr::read_csv("data/analysis/gap_distribution.csv", show_col_types=FALSE) |>
    slice_head(n=25) |>
    knitr::kable(caption="Gap distribution (first 25 gaps)")
if (file.exists("data/analysis/pair_zscan.csv"))
  readr::read_csv("data/analysis/pair_zscan.csv", show_col_types=FALSE) |>
    slice_head(n=20) |>
    knitr::kable(caption="Top 20 pairs by z-score vs uniform")
if (file.exists("outputs/gap_distribution.png")) knitr::include_graphics("outputs/gap_distribution.png")
if (file.exists("outputs/pair_zscan_top20.png")) knitr::include_graphics("outputs/pair_zscan_top20.png")
```

## FDR-Gated Playlists

```{r playlists, message=FALSE, warning=FALSE}
library(readr); library(knitr)
if (file.exists("outputs/playlist_M.csv"))
  readr::read_csv("outputs/playlist_M.csv", show_col_types=FALSE) |> 
    knitr::kable(caption = "Morning playlist (FDR≤0.10, top by prob)")
if (file.exists("outputs/playlist_E.csv"))
  readr::read_csv("outputs/playlist_E.csv", show_col_types=FALSE) |> 
    knitr::kable(caption = "Evening playlist (FDR≤0.10, top by prob)")
```

## FDR-Gated Playlists

```{r playlists_2, message=FALSE, warning=FALSE}
library(readr); library(knitr)
if (file.exists("outputs/playlist_M.csv"))
  readr::read_csv("outputs/playlist_M.csv", show_col_types=FALSE) |> 
    knitr::kable(caption = "Morning playlist (FDR-gated)")
if (file.exists("outputs/playlist_E.csv"))
  readr::read_csv("outputs/playlist_E.csv", show_col_types=FALSE) |> 
    knitr::kable(caption = "Evening playlist (FDR-gated)")
```

## Reliability & Uplift

```{r reliability, message=FALSE, warning=FALSE}
library(knitr)
if (file.exists("outputs/reliability_plot.png"))
  knitr::include_graphics("outputs/reliability_plot.png")
if (file.exists("outputs/uplift_summary.txt"))
  cat(readLines("outputs/uplift_summary.txt"), sep = "\n")
```

## Add-up & Structure Patterns

```{r addups, message=FALSE, warning=FALSE}
library(readr); library(dplyr); library(knitr)
if (file.exists("data/analysis/addups_history.csv"))
  readr::read_csv("data/analysis/addups_history.csv", show_col_types=FALSE) |>
    dplyr::arrange(desc(p)) |>
    slice_head(n = 10) |>
    knitr::kable(caption = "Top add-ups by historical frequency")
if (file.exists("data/analysis/box_top20.csv"))
  readr::read_csv("data/analysis/box_top20.csv", show_col_types=FALSE) |>
    knitr::kable(caption = "Top 20 box classes (unordered pairs)")
```

```{r addups-plots, message=FALSE, warning=FALSE}
if (file.exists("outputs/addups_hist_vs_uniform.png")) knitr::include_graphics("outputs/addups_hist_vs_uniform.png")
if (file.exists("outputs/parity_freq.png")) knitr::include_graphics("outputs/parity_freq.png")
if (file.exists("outputs/lowhigh_freq.png")) knitr::include_graphics("outputs/lowhigh_freq.png")
if (file.exists("outputs/doubles_share.png")) knitr::include_graphics("outputs/doubles_share.png")
if (file.exists("outputs/consecutive_share.png")) knitr::include_graphics("outputs/consecutive_share.png")
```

```{r next-dist, message=FALSE, warning=FALSE}
if (file.exists("data/analysis/next_pattern_distribution.csv")) {
  nd <- readr::read_csv("data/analysis/next_pattern_distribution.csv", show_col_types=FALSE)
  cat("**Model-implied pattern mass for NEXT draw**\n\n")
  nd_sum <- nd |> dplyr::filter(kind=="sum") |> tidyr::pivot_wider(names_from=which, values_from=prob)
  nd_par <- nd |> dplyr::filter(kind=="parity") |> tidyr::pivot_wider(names_from=which, values_from=prob)
  nd_lh  <- nd |> dplyr::filter(kind=="lowhigh") |> tidyr::pivot_wider(names_from=which, values_from=prob)
  nd_sum |> dplyr::arrange(sum)  |> knitr::kable(caption = "Add-up mass (M/E)", digits=4)
  nd_par |> knitr::kable(caption = "Parity mass (M/E)", digits=4)
  nd_lh  |> knitr::kable(caption = "Low/High mass (M/E)", digits=4)
}
```

## Add-Up (Sum) Wheels

```{r sum_wheels, message=FALSE, warning=FALSE}
library(readr); library(dplyr); library(knitr)

show_csv <- function(path, cap) {
  if (!file.exists(path)) return(invisible(NULL))
  readr::read_csv(path, show_col_types = FALSE) %>%
    mutate(pair = ifelse(nchar(as.character(pair))==1,
                         sprintf('%02d', as.integer(pair)),
                         as.character(pair))) %>%
    knitr::kable(caption = cap, digits = 5)
}

show_csv('outputs/playsheet_sumwheel_M.csv', 'Morning sum-wheel (top sums)')
show_csv('outputs/playsheet_sumwheel_E.csv', 'Evening sum-wheel (top sums)')
show_csv('outputs/playsheet_filtered_by_sum.csv', 'Playsheet filtered by favored sums')
```

## Sum Wheels — Intersections & Union

```{r wheels_union, message=FALSE, warning=FALSE}
library(readr); library(knitr)
show <- function(p, cap){ if(file.exists(p)) readr::read_csv(p, show_col_types=FALSE) |> knitr::kable(caption=cap, digits=5) }
show('outputs/playsheet_sumwheel_M_FDR.csv', 'Morning sum-wheel ∩ FDR (may be empty if sums exclude playlist pairs)')
show('outputs/playsheet_sumwheel_E_FDR.csv', 'Evening sum-wheel ∩ FDR (may be empty if sums exclude playlist pairs)')
show('outputs/playsheet_sumwheel_M_UNION.csv', 'Morning sum-wheel ∪ FDR (union, deduped)')
show('outputs/playsheet_sumwheel_E_UNION.csv', 'Evening sum-wheel ∪ FDR (union, deduped)')
```

## Sum-Wheel ∪ Playlist (Union)

```{r sum-union, message=FALSE, warning=FALSE}
library(readr); library(knitr)
show_union <- function(p, cap) {
  if (!file.exists(p)) return(invisible(NULL))
  df <- readr::read_csv(p, show_col_types=FALSE)
  knitr::kable(df, caption = cap)
}
show_union('outputs/playsheet_sumwheel_M_UNION.csv', 'Morning — Sum-wheel ∪ Playlist')
show_union('outputs/playsheet_sumwheel_E_UNION.csv', 'Evening — Sum-wheel ∪ Playlist')
```

## Final Plays (Top 10 per time)

```{r final-plays, message=FALSE, warning=FALSE}
library(readr); library(dplyr); library(knitr)
if (file.exists('outputs/playsheet_final.csv')) {
  readr::read_csv('outputs/playsheet_final.csv', show_col_types=FALSE) |>
    mutate(pair = as.character(pair)) |>
    arrange(time, desc(in_playlist), desc(prob)) |>
    kable(caption = 'Final playsheet (M & E), playlist hits first')
}
```
